---
title: "Reproducible Research: Peer Assessment 1"
output: 
  html_document:
    keep_md: true
---

## Loading and preprocessing the data
We start with the data as a zip file. We need to use the `unz()` function to access the CSV file in the zip:

```{r}
activityTable <- read.csv(unz("activity.zip", "activity.csv"))
str(activityTable)
```

Now we need to pre-process the data in a couple of different ways. First of all, the dates are factors. We want
them as dates. Secondly, the intervals are integers, but they represent clock values (135 represents 1:35 am -
you'll notice there is no 60 or 160 interval). We want to turn those into true integers - the number of minutes
since the start of the day. We effect these two transformations like so:

```{r}
activityTable$date <- as.Date(activityTable$date)
# This one's a little more complicated - interpret it as a string, break into two, then
# back into an integer:
minutesSinceStartOfDay <- function(intervalAsClockTime) {
        intervalString <- toString(intervalAsClockTime)
        stringLength <- nchar(intervalString)
        if (stringLength <= 2) {
                # This is easy; no hour (hour = 0), so just return our input
                return(intervalAsClockTime)
        }
        minutes <- as.integer(substr(intervalString, stringLength - 1, stringLength))
        hours <- as.integer(substr(intervalString, 1, stringLength - 2))
        return(hours * 60 + minutes)
}
# For future use:
clockTimeForMinutes <- function(totalMinutes) {
        hours <- trunc(totalMinutes / 60)
        minutes <- totalMinutes %% 60
        sprintf("%02d:%02d", hours, minutes)
}
activityTable$intervalStartInMinutes <- sapply(activityTable$interval, minutesSinceStartOfDay)
activityTable <- subset(activityTable, select=-c(interval))
str(activityTable)
```
## What is mean total number of steps taken per day?
To calculate the total number of steps per day, we group by day and sum steps. We'll create a histogram and
output the mean and median.
```{r}
stepsPerDay <- aggregate(. ~ date, data=activityTable, FUN=sum)
meanStepsPerDay <- mean(stepsPerDay[, "steps"])
medianStepsPerDay <- as.integer(median(stepsPerDay[, "steps"]))
hist(stepsPerDay[, "steps"], 8, xlab="Steps per day", ylab="Number of days",
     main="Histogram of number of steps per day")
```

The mean steps per day is `r sprintf("%.1f", meanStepsPerDay)` and the median is `r medianStepsPerDay`.
These are very similar, so we can infer that the data is evenly divided around the mean (the histogram
supports this).


## What is the average daily activity pattern?
Find the mean of steps for each interval over all days, and the interval with the highest mean:
```{r}
meanStepsPerInterval <- aggregate(. ~ intervalStartInMinutes, data=activityTable, FUN=mean)

maxMeanStepsIndex <- which.max(meanStepsPerInterval$steps)
maxMeanStepsIntervalStart <- meanStepsPerInterval[maxMeanStepsIndex, "intervalStartInMinutes"]

plot(meanStepsPerInterval$intervalStartInMinutes, meanStepsPerInterval$steps, type="l",
     xlab="Minutes since start of day", ylab="Number of steps", main="Mean steps for each interval")
```

The interval with the most steps, on average, is `r maxMeanStepsIntervalStart` minutes from the start of the
day; in other words, `r clockTimeForMinutes(maxMeanStepsIntervalStart)`.


## Imputing missing values
It's very easy to find the number of rows with NA values:
```{r}
sum(is.na(activityTable))
```

Let's take a look at where the NA values are. Let's sum up the NA values per day:

```{r}
naTable <- activityTable
naTable$isNa <- is.na(naTable$steps)
# remove the steps column so that aggregate/sum doesn't skip over a day of all NAs:
naTable <- subset(naTable, select=-steps)
naStepsPerDay <- aggregate(. ~ date, data=naTable, FUN=sum)
levels(as.factor(naStepsPerDay$isNa))
```

The number of intervals a day is 288 (24 hours times 12 five-minute interval per hour). So this means that every
day has either full data or no data at all.

I'm going to choose the following strategy: any missing day will use the average of the day before and the day after. As it turns out, two of the missing days are the first day and the last day; in those cases we'll use the values for the second day and the second-to-last day, respectively.

```{r}
# I'm sure there's a cleaner, more vector-y way to do this, but this gets the job done:
imputedActivityTable <- activityTable
for (i in 1:nrow(imputedActivityTable)) {
        steps <- imputedActivityTable[i, "steps"]
        if (is.na(steps)) {
                interval <- imputedActivityTable[i, "intervalStartInMinutes"]
                date <- imputedActivityTable[i, "date"]
                yesterdayInterval <- (imputedActivityTable$date == date - 1 &
                                             imputedActivityTable$intervalStartInMinutes == interval)
                tomorrowInterval <- (imputedActivityTable$date == date + 1 &
                                             imputedActivityTable$intervalStartInMinutes == interval)
                newSteps = c(imputedActivityTable[yesterdayInterval, "steps"],
                             imputedActivityTable[tomorrowInterval, "steps"])
                imputedActivityTable[i, "steps"] <- mean(newSteps, na.rm=T)
        }
}
# Verify that we don't have any NAs left:
if (sum(is.na(imputedActivityTable)) > 0) {
        stop("Interpolation function did not fill in all gaps; investigate. Probably a run of three or more
             NA-days.")
}

# Now repeat the analysis in the first step with our new dataset:
stepsPerDayImputed <- aggregate(. ~ date, data=imputedActivityTable, FUN=sum)
meanStepsPerDayImputed <- mean(stepsPerDayImputed[, "steps"])
medianStepsPerDayImputed <- as.integer(median(stepsPerDayImputed[, "steps"]))
hist(stepsPerDayImputed[, "steps"], 8, xlab="Steps per day", ylab="Number of days",
     main="Histogram of number of steps per day (imputed dataset)")
```

The mean steps per day is `r sprintf("%.1f", meanStepsPerDayImputed)` and the median is
`r medianStepsPerDayImputed`. We can see that these values are lower than those in step 1; imputing the
missing data has lowered our estimates of total daily steps.


## Are there differences in activity patterns between weekdays and weekends?
